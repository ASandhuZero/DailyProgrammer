'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Module = require('module');
var path = require('path');
var Utils = require('./index');
var Renderer = require('../renderer');
var Models = require('../models');

var Options = function Options(optsObj) {
    _classCallCheck(this, Options);

    this.vueFileRegex = /([\w/.\-@_\d]*\.vue)/igm;
    this.requireRegex = /(require\(['"])([\w/.\-@_\d]*\.vue)(['"]\))/igm;
    this.appendPaths = optsObj.appendPaths || [];
    this.prependPaths = optsObj.prependPaths || [];
    this.rootPath = optsObj.rootPath || '';
    this.defaults = optsObj.defaults || {};
};

function getVueObject(componentPath, rootPath, vueComponentFileMatch) {
    var GlobalOptions = new Models.Defaults({
        rootPath: rootPath,
        component: componentPath
    });
    return new Promise(function (resolve, reject) {
        Utils.setupComponent(componentPath, GlobalOptions).then(function (component) {
            var rendered = Renderer.renderHtmlUtil(component);
            if (!rendered) {
                reject(new Error('Renderer Error'));
            } else {
                resolve({
                    rendered: rendered,
                    match: vueComponentFileMatch
                });
            }
        }).catch(function (error) {
            reject(error);
        });
    });
}

function replaceRelativePaths(code, rootPath) {
    var parentMatchesSingle = code.match(/(require\('\.\.\/)/gm);
    var currentMatchesSingle = code.match(/(require\('\.\/)/gm);
    var parentMatchesDouble = code.match(/(require\("\.\.\/)/gm);
    var currentMatchesDouble = code.match(/(require\("\.\/)/gm);
    if (parentMatchesSingle) {
        var _iteratorNormalCompletion = true;
        var _didIteratorError = false;
        var _iteratorError = undefined;

        try {
            for (var _iterator = parentMatchesSingle[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                var _match = _step.value;

                code = code.replace(_match, 'require(\'' + rootPath + '/../');
            }
        } catch (err) {
            _didIteratorError = true;
            _iteratorError = err;
        } finally {
            try {
                if (!_iteratorNormalCompletion && _iterator.return) {
                    _iterator.return();
                }
            } finally {
                if (_didIteratorError) {
                    throw _iteratorError;
                }
            }
        }
    }
    if (parentMatchesDouble) {
        var _iteratorNormalCompletion2 = true;
        var _didIteratorError2 = false;
        var _iteratorError2 = undefined;

        try {
            for (var _iterator2 = parentMatchesDouble[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
                var _match2 = _step2.value;

                code = code.replace(_match2, 'require("' + rootPath + '/../');
            }
        } catch (err) {
            _didIteratorError2 = true;
            _iteratorError2 = err;
        } finally {
            try {
                if (!_iteratorNormalCompletion2 && _iterator2.return) {
                    _iterator2.return();
                }
            } finally {
                if (_didIteratorError2) {
                    throw _iteratorError2;
                }
            }
        }
    }
    if (currentMatchesSingle) {
        var _iteratorNormalCompletion3 = true;
        var _didIteratorError3 = false;
        var _iteratorError3 = undefined;

        try {
            for (var _iterator3 = currentMatchesSingle[Symbol.iterator](), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
                var _match3 = _step3.value;

                code = code.replace(_match3, 'require(\'' + rootPath + '/./');
            }
        } catch (err) {
            _didIteratorError3 = true;
            _iteratorError3 = err;
        } finally {
            try {
                if (!_iteratorNormalCompletion3 && _iterator3.return) {
                    _iterator3.return();
                }
            } finally {
                if (_didIteratorError3) {
                    throw _iteratorError3;
                }
            }
        }
    }
    if (currentMatchesDouble) {
        var _iteratorNormalCompletion4 = true;
        var _didIteratorError4 = false;
        var _iteratorError4 = undefined;

        try {
            for (var _iterator4 = currentMatchesDouble[Symbol.iterator](), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
                var _match4 = _step4.value;

                code = code.replace(_match4, 'require("' + rootPath + '/./');
            }
        } catch (err) {
            _didIteratorError4 = true;
            _iteratorError4 = err;
        } finally {
            try {
                if (!_iteratorNormalCompletion4 && _iterator4.return) {
                    _iterator4.return();
                }
            } finally {
                if (_didIteratorError4) {
                    throw _iteratorError4;
                }
            }
        }
    }

    return code;
}

function requireFromString(code) {
    var filename = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';
    var optsObj = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};

    return new Promise(function (resolve, reject) {
        var options = new Options(optsObj);
        var promiseArray = [];

        if (typeof code !== 'string') {
            throw new Error('code must be a string, not ' + (typeof code === 'undefined' ? 'undefined' : _typeof(code)));
        }
        code = replaceRelativePaths(code, options.rootPath);
        var paths = Module._nodeModulePaths(path.dirname(filename));
        var m = new Module(filename, options.rootPath);
        m.filename = filename;
        m.paths = [].concat(options.prependPaths).concat(paths).concat(options.appendPaths);

        //find matches for the require paths
        var vueComponentFileMatches = code.match(options.requireRegex);
        if (vueComponentFileMatches && vueComponentFileMatches.length > 0) {
            //iterate through the matches
            for (var index = 0; index < vueComponentFileMatches.length; index++) {
                var vueComponentFileMatch = vueComponentFileMatches[index];
                //get the file out of the require string
                //this is because its easier to do string replace later
                var vueComponentFile = vueComponentFileMatch.match(options.vueFileRegex);
                if (vueComponentFile && vueComponentFile.length > 0) {
                    promiseArray.push(getVueObject(vueComponentFile[0], options.rootPath, vueComponentFileMatch));
                }
            }
            Promise.all(promiseArray).then(function (renderedItemArray) {
                var _iteratorNormalCompletion5 = true;
                var _didIteratorError5 = false;
                var _iteratorError5 = undefined;

                try {
                    for (var _iterator5 = renderedItemArray[Symbol.iterator](), _step5; !(_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done); _iteratorNormalCompletion5 = true) {
                        var renderedItem = _step5.value;

                        var rawString = renderedItem.rendered.scriptStringRaw;
                        code = code.replace(renderedItem.match, rawString);
                    }
                    //check if its the last element and then render
                } catch (err) {
                    _didIteratorError5 = true;
                    _iteratorError5 = err;
                } finally {
                    try {
                        if (!_iteratorNormalCompletion5 && _iterator5.return) {
                            _iterator5.return();
                        }
                    } finally {
                        if (_didIteratorError5) {
                            throw _iteratorError5;
                        }
                    }
                }

                var last_element = code.match(options.vueFileRegex);
                if (last_element === undefined || last_element === null) {
                    m._compile(code, filename);
                    resolve(m.exports.default);
                }
            }).catch(function (error) {
                reject(error);
            });
        } else {
            m._compile(code, filename);
            resolve(m.exports.default);
        }
    });
}

module.exports = requireFromString;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9yZXF1aXJlLmpzIl0sIm5hbWVzIjpbIk1vZHVsZSIsInJlcXVpcmUiLCJwYXRoIiwiVXRpbHMiLCJSZW5kZXJlciIsIk1vZGVscyIsIk9wdGlvbnMiLCJvcHRzT2JqIiwidnVlRmlsZVJlZ2V4IiwicmVxdWlyZVJlZ2V4IiwiYXBwZW5kUGF0aHMiLCJwcmVwZW5kUGF0aHMiLCJyb290UGF0aCIsImRlZmF1bHRzIiwiZ2V0VnVlT2JqZWN0IiwiY29tcG9uZW50UGF0aCIsInZ1ZUNvbXBvbmVudEZpbGVNYXRjaCIsIkdsb2JhbE9wdGlvbnMiLCJEZWZhdWx0cyIsImNvbXBvbmVudCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwic2V0dXBDb21wb25lbnQiLCJ0aGVuIiwicmVuZGVyZWQiLCJyZW5kZXJIdG1sVXRpbCIsIkVycm9yIiwibWF0Y2giLCJjYXRjaCIsImVycm9yIiwicmVwbGFjZVJlbGF0aXZlUGF0aHMiLCJjb2RlIiwicGFyZW50TWF0Y2hlc1NpbmdsZSIsImN1cnJlbnRNYXRjaGVzU2luZ2xlIiwicGFyZW50TWF0Y2hlc0RvdWJsZSIsImN1cnJlbnRNYXRjaGVzRG91YmxlIiwicmVwbGFjZSIsInJlcXVpcmVGcm9tU3RyaW5nIiwiZmlsZW5hbWUiLCJvcHRpb25zIiwicHJvbWlzZUFycmF5IiwicGF0aHMiLCJfbm9kZU1vZHVsZVBhdGhzIiwiZGlybmFtZSIsIm0iLCJjb25jYXQiLCJ2dWVDb21wb25lbnRGaWxlTWF0Y2hlcyIsImxlbmd0aCIsImluZGV4IiwidnVlQ29tcG9uZW50RmlsZSIsInB1c2giLCJhbGwiLCJyZW5kZXJlZEl0ZW1BcnJheSIsInJlbmRlcmVkSXRlbSIsInJhd1N0cmluZyIsInNjcmlwdFN0cmluZ1JhdyIsImxhc3RfZWxlbWVudCIsInVuZGVmaW5lZCIsIl9jb21waWxlIiwiZXhwb3J0cyIsImRlZmF1bHQiLCJtb2R1bGUiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLElBQU1BLFNB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QUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBOztBQU12QixvQkFBTUUsZUFBZXpCLEtBQUtKLEtBQUwsQ0FBV1ksUUFBUWhDLFlBQW5CLENBQXJCO0FBQ0Esb0JBQUlpRCxpQkFBaUJDLFNBQWpCLElBQThCRCxpQkFBaUIsSUFBbkQsRUFBeUQ7QUFDckRaLHNCQUFFYyxRQUFGLENBQVczQixJQUFYLEVBQWlCTyxRQUFqQjtBQUNBbEIsNEJBQVF3QixFQUFFZSxPQUFGLENBQVVDLE9BQWxCO0FBQ0g7QUFDSixhQVpMLEVBYUtoQyxLQWJMLENBYVcsaUJBQVM7QUFDWlAsdUJBQU9RLEtBQVA7QUFDSCxhQWZMO0FBZ0JILFNBM0JELE1BMkJPO0FBQ0hlLGNBQUVjLFFBQUYsQ0FBVzNCLElBQVgsRUFBaUJPLFFBQWpCO0FBQ0FsQixvQkFBUXdCLEVBQUVlLE9BQUYsQ0FBVUMsT0FBbEI7QUFDSDtBQUNKLEtBOUNNLENBQVA7QUErQ0g7O0FBRURDLE9BQU9GLE9BQVAsR0FBaUJ0QixpQkFBakIiLCJmaWxlIjoicmVxdWlyZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5jb25zdCBNb2R1bGUgPSByZXF1aXJlKCdtb2R1bGUnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBVdGlscyA9IHJlcXVpcmUoJy4vaW5kZXgnKTtcbmNvbnN0IFJlbmRlcmVyID0gcmVxdWlyZSgnLi4vcmVuZGVyZXInKTtcbmNvbnN0IE1vZGVscyA9IHJlcXVpcmUoJy4uL21vZGVscycpO1xuXG5jbGFzcyBPcHRpb25zIHtcbiAgICB2dWVGaWxlUmVnZXg6IFJlZ0V4cDtcbiAgICByZXF1aXJlUmVnZXg6IFJlZ0V4cDtcbiAgICBhcHBlbmRQYXRoczogc3RyaW5nW107XG4gICAgcHJlcGVuZFBhdGhzOiBzdHJpbmdbXTtcbiAgICByb290UGF0aDogc3RyaW5nO1xuICAgIGRlZmF1bHRzOiBNb2RlbHMuRGVmYXVsdHM7XG4gICAgY29uc3RydWN0b3Iob3B0c09iajogT2JqZWN0KSB7XG4gICAgICAgIHRoaXMudnVlRmlsZVJlZ2V4ID0gLyhbXFx3Ly5cXC1AX1xcZF0qXFwudnVlKS9pZ207XG4gICAgICAgIHRoaXMucmVxdWlyZVJlZ2V4ID0gLyhyZXF1aXJlXFwoWydcIl0pKFtcXHcvLlxcLUBfXFxkXSpcXC52dWUpKFsnXCJdXFwpKS9pZ207XG4gICAgICAgIHRoaXMuYXBwZW5kUGF0aHMgPSBvcHRzT2JqLmFwcGVuZFBhdGhzIHx8IFtdO1xuICAgICAgICB0aGlzLnByZXBlbmRQYXRocyA9IG9wdHNPYmoucHJlcGVuZFBhdGhzIHx8IFtdO1xuICAgICAgICB0aGlzLnJvb3RQYXRoID0gb3B0c09iai5yb290UGF0aCB8fCAnJztcbiAgICAgICAgdGhpcy5kZWZhdWx0cyA9IG9wdHNPYmouZGVmYXVsdHMgfHwge307XG4gICAgfVxufVxuXG5mdW5jdGlvbiBnZXRWdWVPYmplY3QoY29tcG9uZW50UGF0aDogc3RyaW5nLCByb290UGF0aDogc3RyaW5nLCB2dWVDb21wb25lbnRGaWxlTWF0Y2g6IHN0cmluZyk6IFByb21pc2UgPCB7cmVuZGVyZWQ6T2JqZWN0LCBtYXRjaDogc3RyaW5nfSA+IHtcbiAgICBjb25zdCBHbG9iYWxPcHRpb25zID0gbmV3IE1vZGVscy5EZWZhdWx0cyh7XG4gICAgICAgIHJvb3RQYXRoOiByb290UGF0aCxcbiAgICAgICAgY29tcG9uZW50OiBjb21wb25lbnRQYXRoXG4gICAgfSk7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgVXRpbHMuc2V0dXBDb21wb25lbnQoY29tcG9uZW50UGF0aCwgR2xvYmFsT3B0aW9ucylcbiAgICAgICAgICAgIC50aGVuKGNvbXBvbmVudCA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVuZGVyZWQgPSBSZW5kZXJlci5yZW5kZXJIdG1sVXRpbChjb21wb25lbnQpO1xuICAgICAgICAgICAgICAgIGlmICghcmVuZGVyZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignUmVuZGVyZXIgRXJyb3InKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJlZDogcmVuZGVyZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXRjaDogdnVlQ29tcG9uZW50RmlsZU1hdGNoXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gcmVwbGFjZVJlbGF0aXZlUGF0aHMoY29kZTogc3RyaW5nLCByb290UGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBwYXJlbnRNYXRjaGVzU2luZ2xlID0gY29kZS5tYXRjaCgvKHJlcXVpcmVcXCgnXFwuXFwuXFwvKS9nbSk7XG4gICAgY29uc3QgY3VycmVudE1hdGNoZXNTaW5nbGUgPSBjb2RlLm1hdGNoKC8ocmVxdWlyZVxcKCdcXC5cXC8pL2dtKTtcbiAgICBjb25zdCBwYXJlbnRNYXRjaGVzRG91YmxlID0gY29kZS5tYXRjaCgvKHJlcXVpcmVcXChcIlxcLlxcLlxcLykvZ20pO1xuICAgIGNvbnN0IGN1cnJlbnRNYXRjaGVzRG91YmxlID0gY29kZS5tYXRjaCgvKHJlcXVpcmVcXChcIlxcLlxcLykvZ20pO1xuICAgIGlmIChwYXJlbnRNYXRjaGVzU2luZ2xlKSB7XG4gICAgICAgIGZvciAoY29uc3QgbWF0Y2ggb2YgcGFyZW50TWF0Y2hlc1NpbmdsZSkge1xuICAgICAgICAgICAgY29kZSA9IGNvZGUucmVwbGFjZShtYXRjaCwgYHJlcXVpcmUoJyR7cm9vdFBhdGh9Ly4uL2ApO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChwYXJlbnRNYXRjaGVzRG91YmxlKSB7XG4gICAgICAgIGZvciAoY29uc3QgbWF0Y2ggb2YgcGFyZW50TWF0Y2hlc0RvdWJsZSkge1xuICAgICAgICAgICAgY29kZSA9IGNvZGUucmVwbGFjZShtYXRjaCwgYHJlcXVpcmUoXCIke3Jvb3RQYXRofS8uLi9gKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoY3VycmVudE1hdGNoZXNTaW5nbGUpIHtcbiAgICAgICAgZm9yIChjb25zdCBtYXRjaCBvZiBjdXJyZW50TWF0Y2hlc1NpbmdsZSkge1xuICAgICAgICAgICAgY29kZSA9IGNvZGUucmVwbGFjZShtYXRjaCwgYHJlcXVpcmUoJyR7cm9vdFBhdGh9Ly4vYCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGN1cnJlbnRNYXRjaGVzRG91YmxlKSB7XG4gICAgICAgIGZvciAoY29uc3QgbWF0Y2ggb2YgY3VycmVudE1hdGNoZXNEb3VibGUpIHtcbiAgICAgICAgICAgIGNvZGUgPSBjb2RlLnJlcGxhY2UobWF0Y2gsIGByZXF1aXJlKFwiJHtyb290UGF0aH0vLi9gKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjb2RlO1xufVxuXG5cbmZ1bmN0aW9uIHJlcXVpcmVGcm9tU3RyaW5nKGNvZGU6IHN0cmluZywgZmlsZW5hbWU6IHN0cmluZyA9ICcnLCBvcHRzT2JqOiBPYmplY3QgPSB7fSk6IFByb21pc2UgPCBPYmplY3QgPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IG5ldyBPcHRpb25zKG9wdHNPYmopO1xuICAgICAgICBsZXQgcHJvbWlzZUFycmF5ID0gW107XG5cbiAgICAgICAgaWYgKHR5cGVvZiBjb2RlICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdjb2RlIG11c3QgYmUgYSBzdHJpbmcsIG5vdCAnICsgdHlwZW9mIGNvZGUpO1xuICAgICAgICB9XG4gICAgICAgIGNvZGUgPSByZXBsYWNlUmVsYXRpdmVQYXRocyhjb2RlLCBvcHRpb25zLnJvb3RQYXRoKTtcbiAgICAgICAgbGV0IHBhdGhzID0gTW9kdWxlLl9ub2RlTW9kdWxlUGF0aHMocGF0aC5kaXJuYW1lKGZpbGVuYW1lKSk7XG4gICAgICAgIHZhciBtID0gbmV3IE1vZHVsZShmaWxlbmFtZSwgb3B0aW9ucy5yb290UGF0aCk7XG4gICAgICAgIG0uZmlsZW5hbWUgPSBmaWxlbmFtZTtcbiAgICAgICAgbS5wYXRocyA9IFtdLmNvbmNhdChvcHRpb25zLnByZXBlbmRQYXRocykuY29uY2F0KHBhdGhzKS5jb25jYXQob3B0aW9ucy5hcHBlbmRQYXRocyk7XG5cbiAgICAgICAgLy9maW5kIG1hdGNoZXMgZm9yIHRoZSByZXF1aXJlIHBhdGhzXG4gICAgICAgIGxldCB2dWVDb21wb25lbnRGaWxlTWF0Y2hlcyA9IGNvZGUubWF0Y2gob3B0aW9ucy5yZXF1aXJlUmVnZXgpO1xuICAgICAgICBpZiAodnVlQ29tcG9uZW50RmlsZU1hdGNoZXMgJiYgdnVlQ29tcG9uZW50RmlsZU1hdGNoZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgLy9pdGVyYXRlIHRocm91Z2ggdGhlIG1hdGNoZXNcbiAgICAgICAgICAgIGZvciAodmFyIGluZGV4ID0gMDsgaW5kZXggPCB2dWVDb21wb25lbnRGaWxlTWF0Y2hlcy5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgICAgICAgICAgICB2YXIgdnVlQ29tcG9uZW50RmlsZU1hdGNoID0gdnVlQ29tcG9uZW50RmlsZU1hdGNoZXNbaW5kZXhdO1xuICAgICAgICAgICAgICAgIC8vZ2V0IHRoZSBmaWxlIG91dCBvZiB0aGUgcmVxdWlyZSBzdHJpbmdcbiAgICAgICAgICAgICAgICAvL3RoaXMgaXMgYmVjYXVzZSBpdHMgZWFzaWVyIHRvIGRvIHN0cmluZyByZXBsYWNlIGxhdGVyXG4gICAgICAgICAgICAgICAgY29uc3QgdnVlQ29tcG9uZW50RmlsZSA9IHZ1ZUNvbXBvbmVudEZpbGVNYXRjaC5tYXRjaChvcHRpb25zLnZ1ZUZpbGVSZWdleCk7XG4gICAgICAgICAgICAgICAgaWYgKHZ1ZUNvbXBvbmVudEZpbGUgJiYgdnVlQ29tcG9uZW50RmlsZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHByb21pc2VBcnJheS5wdXNoKGdldFZ1ZU9iamVjdCh2dWVDb21wb25lbnRGaWxlWzBdLCBvcHRpb25zLnJvb3RQYXRoLCB2dWVDb21wb25lbnRGaWxlTWF0Y2gpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBQcm9taXNlLmFsbChwcm9taXNlQXJyYXkpXG4gICAgICAgICAgICAgICAgLnRoZW4ocmVuZGVyZWRJdGVtQXJyYXkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciByZW5kZXJlZEl0ZW0gb2YgcmVuZGVyZWRJdGVtQXJyYXkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhd1N0cmluZyA9IHJlbmRlcmVkSXRlbS5yZW5kZXJlZC5zY3JpcHRTdHJpbmdSYXc7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb2RlID0gY29kZS5yZXBsYWNlKHJlbmRlcmVkSXRlbS5tYXRjaCwgcmF3U3RyaW5nKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvL2NoZWNrIGlmIGl0cyB0aGUgbGFzdCBlbGVtZW50IGFuZCB0aGVuIHJlbmRlclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0X2VsZW1lbnQgPSBjb2RlLm1hdGNoKG9wdGlvbnMudnVlRmlsZVJlZ2V4KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3RfZWxlbWVudCA9PT0gdW5kZWZpbmVkIHx8IGxhc3RfZWxlbWVudCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbS5fY29tcGlsZShjb2RlLCBmaWxlbmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG0uZXhwb3J0cy5kZWZhdWx0KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG0uX2NvbXBpbGUoY29kZSwgZmlsZW5hbWUpO1xuICAgICAgICAgICAgcmVzb2x2ZShtLmV4cG9ydHMuZGVmYXVsdCk7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlRnJvbVN0cmluZztcbiJdfQ==